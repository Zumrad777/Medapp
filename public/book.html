<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Запись на прием - MedApp</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">
                <i class="fas fa-hospital"></i>
                <span>MedApp</span>
            </a>
            <div class="nav-links">
                <a href="/dashboard">Панель</a>
                <a href="/doctors">Врачи</a>
                <a href="/appointments">Записи</a>
                <a href="/profile">Профиль</a>
                <a href="#" onclick="logout()" class="btn btn-outline">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 40px; max-width: 800px;">
        <div id="message" style="display: none;" class="alert"></div>
        
        <h1><i class="fas fa-calendar-plus"></i> Новая запись</h1>
        
        <div class="form-container" style="margin-top: 30px;">
            <form id="bookingForm">
                <div class="form-group">
                    <label for="doctorSelect">Выберите врача *</label>
                    <select id="doctorSelect" class="form-control" required>
                        <option value="">-- Выберите врача --</option>
                        <!-- Врачи будут загружены динамически -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="appointmentDate">Дата и время приема *</label>
                    <input type="datetime-local" id="appointmentDate" class="form-control" required>
                    <div class="form-text">Минимальное время записи - за 2 часа до приема</div>
                </div>
                
                <div class="form-group">
                    <label for="reason">Причина визита *</label>
                    <textarea id="reason" class="form-control" rows="4" required 
                              placeholder="Опишите причину обращения к врачу..."></textarea>
                    <div class="form-text">Будьте максимально подробны, это поможет врачу подготовиться</div>
                </div>
                
                <div class="form-group">
                    <label for="symptoms">Симптомы (необязательно)</label>
                    <input type="text" id="symptoms" class="form-control" 
                           placeholder="Например: головная боль, температура, тошнота...">
                    <div class="form-text">Перечислите симптомы через запятую</div>
                </div>
                
                <div class="form-group">
                    <label for="duration">Длительность приема (минут)</label>
                    <select id="duration" class="form-control">
                        <option value="30">30 минут</option>
                        <option value="45">45 минут</option>
                        <option value="60">60 минут</option>
                        <option value="90">90 минут</option>
                    </select>
                </div>
                
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-calendar-check"></i> Записаться
                    </button>
                    <button type="button" class="btn btn-outline" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> Назад
                    </button>
                </div>
            </form>
        </div>
        
        <div id="selectedDoctorInfo" style="margin-top: 30px; display: none;">
            <div class="doctor-preview">
                <div class="doctor-image-preview">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="doctor-info-preview">
                    <h3 id="doctorName">Доктор Смит</h3>
                    <p id="doctorSpecialization">Кардиолог</p>
                    <p id="doctorSchedule">График работы: Пн-Пт, 9:00-18:00</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/utils.js"></script>
    <script>
        // Проверка авторизации
        if (!getToken()) {
            window.location.href = '/login';
        }
        
        // Загрузка врачей
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDoctors();
            
            // Проверка параметра doctor в URL
            const urlParams = new URLSearchParams(window.location.search);
            const doctorId = urlParams.get('doctor');
            if (doctorId) {
                document.getElementById('doctorSelect').value = doctorId;
                await showDoctorInfo(doctorId);
            }
            
            // Установка минимальной даты (текущее время + 2 часа)
            const now = new Date();
            now.setHours(now.getHours() + 2);
            const minDate = now.toISOString().slice(0, 16);
            document.getElementById('appointmentDate').min = minDate;
            
            // Установка дефолтной даты (завтра в 10:00)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(10, 0, 0, 0);
            document.getElementById('appointmentDate').value = tomorrow.toISOString().slice(0, 16);
        });
        
        async function loadDoctors() {
            try {
                const response = await fetch('/api/doctors');
                if (!response.ok) return;
                
                const doctors = await response.json();
                const select = document.getElementById('doctorSelect');
                
                doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor._id;
                    option.textContent = `${doctor.fullName} - ${doctor.specialization || 'Врач'}`;
                    select.appendChild(option);
                });
                
                // Обработчик изменения выбора врача
                select.addEventListener('change', async (e) => {
                    if (e.target.value) {
                        await showDoctorInfo(e.target.value);
                    } else {
                        document.getElementById('selectedDoctorInfo').style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error('Error loading doctors:', error);
            }
        }
        
        async function showDoctorInfo(doctorId) {
            try {
                const response = await fetch(`/api/doctors/${doctorId}`);
                if (!response.ok) return;
                
                const doctor = await response.json();
                const infoContainer = document.getElementById('selectedDoctorInfo');
                
                document.getElementById('doctorName').textContent = doctor.fullName;
                document.getElementById('doctorSpecialization').textContent = doctor.specialization || 'Врач';
                
                infoContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading doctor info:', error);
            }
        }
        
        // Обработка формы
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                doctorId: document.getElementById('doctorSelect').value,
                appointmentDate: document.getElementById('appointmentDate').value,
                reason: document.getElementById('reason').value,
                symptoms: document.getElementById('symptoms').value,
                duration: parseInt(document.getElementById('duration').value)
            };
            
            // Валидация
            if (!formData.doctorId) {
                showMessage('danger', 'Выберите врача');
                return;
            }
            
            const selectedDate = new Date(formData.appointmentDate);
            const now = new Date();
            now.setHours(now.getHours() + 2);
            
            if (selectedDate < now) {
                showMessage('danger', 'Выберите дату минимум на 2 часа позже текущего времени');
                return;
            }
            
            // Отправка
            try {
                const response = await apiRequest('/api/appointments', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (response && response.ok) {
                    const result = await response.json();
                    showMessage('success', 'Запись успешно создана!');
                    
                    // Очистка формы
                    document.getElementById('bookingForm').reset();
                    document.getElementById('selectedDoctorInfo').style.display = 'none';
                    
                    // Перенаправление через 2 секунды
                    setTimeout(() => {
                        window.location.href = '/appointments';
                    }, 2000);
                } else {
                    const error = await response.json();
                    showMessage('danger', error.message || 'Ошибка при создании записи');
                }
            } catch (error) {
                showMessage('danger', 'Ошибка сети');
            }
        });
        
        // Добавляем стили для предпросмотра врача
        const style = document.createElement('style');
        style.textContent = `
            .doctor-preview {
                display: flex;
                gap: 20px;
                align-items: center;
                padding: 20px;
                background: white;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow);
            }
            
            .doctor-image-preview {
                width: 80px;
                height: 80px;
                background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .doctor-image-preview i {
                font-size: 2.5rem;
                color: white;
            }
            
            .doctor-info-preview h3 {
                margin: 0 0 5px 0;
            }
            
            .doctor-info-preview p {
                margin: 5px 0;
                color: var(--text-light);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>